openapi: 3.0.3
info:
  title: ChronoAtlas API
  version: 0.1.0
servers:
  - url: http://localhost:{port}
    variables:
      port:
        default: "3000"
        description: "后端端口（来自 app-config.json 的 ports.backend）"
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseHealth"

  /api/hello:
    get:
      summary: Hello endpoint
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseHello"

  /auth/register:
    post:
      summary: Register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthRegisterRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseRegister"
        "400":
          $ref: "#/components/responses/Error400"

  /auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /auth/logout:
    post:
      summary: Logout
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "401":
          $ref: "#/components/responses/Error401"

  /auth/refresh:
    post:
      summary: Refresh token
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /auth/verify-email:
    post:
      summary: Verify email
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyEmailRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "400":
          $ref: "#/components/responses/Error400"

  /auth/forgot-password:
    post:
      summary: Forgot password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ForgotPasswordRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "400":
          $ref: "#/components/responses/Error400"

  /auth/reset-password:
    post:
      summary: Reset password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResetPasswordRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "400":
          $ref: "#/components/responses/Error400"

  /auth/change-password:
    post:
      summary: Change password
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"

  /auth/profile:
    patch:
      summary: Update profile
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProfileRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"

  /auth/me:
    get:
      summary: Current user
      security:
        - CookieAuth: []
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "401":
          $ref: "#/components/responses/Error401"

  /users:
    get:
      summary: List users
      security:
        - CookieAuth: []
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUsersList"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      summary: Create user
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /users/{id}:
    patch:
      summary: Update user
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseUser"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /settings/smtp:
    get:
      summary: Get SMTP settings
      security:
        - CookieAuth: []
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseSmtpSettings"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    put:
      summary: Update SMTP settings
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateSmtpSettingsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseSmtpSettings"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /events/approvals:
    get:
      summary: List event approvals
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pending, approved, rejected]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEventApprovals"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /events/approvals/{id}/approve:
    post:
      summary: Approve event approval
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApprovalDecisionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseApprovalDecision"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events/approvals/{id}/reject:
    post:
      summary: Reject event approval
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApprovalDecisionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseApprovalDecision"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events:
    get:
      summary: List events
      parameters:
        - in: query
          name: timeFrom
          schema:
            type: integer
        - in: query
          name: timeTo
          schema:
            type: integer
        - in: query
          name: tagIds
          schema:
            type: string
          description: Comma-separated ids
        - in: query
          name: tagMatch
          schema:
            type: string
            enum:
              - any
              - all
          description: Match mode for tagIds (any or all). Default is all.
        - in: query
          name: keyword
          schema:
            type: string
        - in: query
          name: q
          schema:
            type: string
          description: Alias of keyword
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEventsList"
        "400":
          $ref: "#/components/responses/Error400"
    post:
      summary: Create event
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventDraft"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEvent"
        "202":
          description: Accepted (approval required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePending"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /events/search:
    get:
      summary: Search events
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEventsList"
        "400":
          $ref: "#/components/responses/Error400"

  /events/aggregations:
    get:
      summary: Event aggregations
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEventAggregations"

  /events/{id}:
    get:
      summary: Get event by id
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEvent"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      summary: Update event
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventPatch"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEvent"
        "202":
          description: Accepted (approval required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePending"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      summary: Delete event
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "202":
          description: Accepted (approval required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponsePending"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events/{id}/versions:
    get:
      summary: Event versions
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEventVersions"

  /events/{id}/restore:
    post:
      summary: Restore event version
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventRestoreRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseEvent"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /tags:
    get:
      summary: List tags
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseTagsList"
    post:
      summary: Create tag
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NamedItemDraft"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseTag"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /tags/{id}:
    patch:
      summary: Update tag
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NamedItemDraft"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseTag"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      summary: Delete tag
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
        - $ref: "#/components/parameters/CsrfTokenHeader"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseOk"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /import/events:
    post:
      summary: Import events
      security:
        - CookieAuth: []
        - BearerAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfTokenHeader"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ImportEventsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseImportEvents"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /export/events:
    get:
      summary: Export events
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponseExportEvents"

components:
  securitySchemes:
    CookieAuth:
      type: apiKey
      in: cookie
      name: access_token
    BearerAuth:
      type: http
      scheme: bearer
  parameters:
    CsrfTokenHeader:
      name: X-CSRF-Token
      in: header
      required: true
      schema:
        type: string
      description: 与 csrf_token Cookie 相同
  responses:
    Error400:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error401:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error403:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Error404:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
  schemas:
    ApiResponse:
      type: object
      required: [code, message, data, traceId]
      properties:
        code:
          type: string
        message:
          type: string
        data:
          nullable: true
        traceId:
          type: string

    ErrorResponse:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            code:
              type: string
              example: AUTH_001
            message:
              type: string
              example: 需要登录
            data:
              nullable: true

    ApiResponseOk:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [ok]
              properties:
                ok:
                  type: boolean

    ApiResponseHealth:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                status:
                  type: string
                time:
                  type: string

    ApiResponseHello:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              properties:
                message:
                  type: string
                time:
                  type: string

    ApiResponseUser:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [user]
              properties:
                user:
                  $ref: "#/components/schemas/User"

    ApiResponseRegister:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [user, emailSent]
              properties:
                user:
                  $ref: "#/components/schemas/User"
                emailSent:
                  type: boolean

    ApiResponseUsersList:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [items]
              properties:
                items:
                  type: array
                  items:
                    $ref: "#/components/schemas/User"

    ApiResponseSmtpSettings:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [settings]
              properties:
                settings:
                  $ref: "#/components/schemas/SmtpSettings"

    ApiResponseEvent:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/Event"

    ApiResponseEventsList:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [items, total]
              properties:
                items:
                  type: array
                  items:
                    $ref: "#/components/schemas/Event"
                total:
                  type: integer

    ApiResponsePending:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/PendingResponse"

    ApiResponseEventVersions:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [items]
              properties:
                items:
                  type: array
                  items:
                    $ref: "#/components/schemas/EventVersion"

    ApiResponseEventApprovals:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [items]
              properties:
                items:
                  type: array
                  items:
                    $ref: "#/components/schemas/EventApproval"

    ApiResponseApprovalDecision:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [ok, approval]
              properties:
                ok:
                  type: boolean
                approval:
                  $ref: "#/components/schemas/EventApproval"

    ApiResponseTag:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/Tag"

    ApiResponseTagsList:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              type: object
              required: [items]
              properties:
                items:
                  type: array
                  items:
                    $ref: "#/components/schemas/Tag"

    ApiResponseImportEvents:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/ImportEventsResponse"

    ApiResponseExportEvents:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/ExportEventsResponse"

    ApiResponseEventAggregations:
      allOf:
        - $ref: "#/components/schemas/ApiResponse"
        - type: object
          properties:
            data:
              $ref: "#/components/schemas/EventAggregations"

    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    AuthRegisterRequest:
      type: object
      required: [email, displayName, password]
      properties:
        email:
          type: string
        displayName:
          type: string
        password:
          type: string

    VerifyEmailRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string

    ForgotPasswordRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string

    ResetPasswordRequest:
      type: object
      required: [token, newPassword]
      properties:
        token:
          type: string
        newPassword:
          type: string

    ChangePasswordRequest:
      type: object
      required: [currentPassword, newPassword]
      properties:
        currentPassword:
          type: string
        newPassword:
          type: string

    UpdateProfileRequest:
      type: object
      required: [displayName]
      properties:
        displayName:
          type: string

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        displayName:
          type: string
        roles:
          type: array
          items:
            $ref: "#/components/schemas/RoleName"
        isActive:
          type: boolean
        emailVerified:
          type: boolean
        createdAt:
          type: string
        updatedAt:
          type: string
        lastLoginAt:
          type: string
          nullable: true

    RoleName:
      type: string
      enum: [SUPER_ADMIN, ADMIN, EDITOR, USER]

    CreateUserRequest:
      type: object
      required: [email, displayName, password]
      properties:
        email:
          type: string
        displayName:
          type: string
        password:
          type: string
        roles:
          type: array
          items:
            $ref: "#/components/schemas/RoleName"
        isActive:
          type: boolean

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
        displayName:
          type: string
        password:
          type: string
        roles:
          type: array
          items:
            $ref: "#/components/schemas/RoleName"
        isActive:
          type: boolean

    SmtpSettings:
      type: object
      properties:
        enabled:
          type: boolean
        host:
          type: string
        port:
          type: integer
        secure:
          type: boolean
        username:
          type: string
        fromAddress:
          type: string
        hasPassword:
          type: boolean
        updatedAt:
          type: string
          nullable: true

    UpdateSmtpSettingsRequest:
      type: object
      required: [enabled]
      properties:
        enabled:
          type: boolean
        host:
          type: string
        port:
          type: integer
        secure:
          type: boolean
        username:
          type: string
        password:
          type: string
        fromAddress:
          type: string

    TimePoint:
      type: object
      required: [year]
      properties:
        year:
          type: integer
        month:
          type: integer
        day:
          type: integer

    EventTime:
      type: object
      required: [start, precision]
      properties:
        start:
          $ref: "#/components/schemas/TimePoint"
        end:
          $ref: "#/components/schemas/TimePoint"
        precision:
          type: string
          enum: [century, decade, year, month, day]
        fuzzy:
          type: object

    EventDraft:
      type: object
      required: [title, time]
      properties:
        title:
          type: string
        summary:
          type: string
        time:
          $ref: "#/components/schemas/EventTime"
        tagIds:
          type: array
          items:
            type: string
          description: 创建/更新/导入时可填写名称，系统会自动匹配或创建

    EventPatch:
      type: object
      properties:
        title:
          type: string
        summary:
          type: string
        time:
          $ref: "#/components/schemas/EventTime"
        tagIds:
          type: array
          items:
            type: string
          description: 创建/更新/导入时可填写名称，系统会自动匹配或创建

    Event:
      allOf:
        - $ref: "#/components/schemas/EventDraft"
        - type: object
          required: [id, createdAt, updatedAt]
          properties:
            id:
              type: string
            tags:
              type: array
              items:
                $ref: "#/components/schemas/Tag"
            createdAt:
              type: string
            updatedAt:
              type: string

    PendingResponse:
      type: object
      required: [pending, approvalId]
      properties:
        pending:
          type: boolean
        approvalId:
          type: string

    EventVersion:
      type: object
      properties:
        id:
          type: string
        eventId:
          type: string
        action:
          type: string
        changedAt:
          type: string
        changedBy:
          type: string
        note:
          type: string
        snapshot:
          $ref: "#/components/schemas/Event"

    EventRestoreRequest:
      type: object
      required: [versionId]
      properties:
        versionId:
          type: string

    EventApproval:
      type: object
      properties:
        id:
          type: string
        action:
          type: string
        eventId:
          type: string
        draft:
          $ref: "#/components/schemas/EventDraft"
        snapshot:
          $ref: "#/components/schemas/Event"
        requestedAt:
          type: string
        requestedBy:
          type: string
        requestedByName:
          type: string
        status:
          type: string
        decidedAt:
          type: string
        decidedBy:
          type: string
        note:
          type: string
        resultEventId:
          type: string

    ApprovalDecisionRequest:
      type: object
      properties:
        note:
          type: string

    Tag:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        parentId:
          type: string

    NamedItemDraft:
      type: object
      required: [name]
      properties:
        name:
          type: string
        parentId:
          type: string

    ImportEventsRequest:
      type: object
      required: [items]
      properties:
        mode:
          type: string
          enum: [merge, replace]
        items:
          type: array
          items:
            $ref: "#/components/schemas/EventDraft"

    ImportEventsResponse:
      type: object
      required: [mode, imported]
      properties:
        mode:
          type: string
        imported:
          type: integer

    ExportEventsResponse:
      type: object
      required: [exportedAt, total, items]
      properties:
        exportedAt:
          type: string
        total:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/Event"

    EventAggregations:
      type: object
      properties:
        total:
          type: integer
        years:
          type: object
          properties:
            min:
              type: integer
            max:
              type: integer
        tags:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              count:
                type: integer
