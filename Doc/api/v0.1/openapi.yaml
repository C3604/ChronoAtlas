openapi: 3.0.3
info:
  title: ChronoAtlas API
  version: 0.1.0
servers:
  - url: http://localhost:3000
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  time:
                    type: string

  /api/hello:
    get:
      summary: Hello endpoint
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  time:
                    type: string

  /auth/login:
    post:
      summary: Login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthLoginResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"

  /auth/me:
    get:
      summary: Current user
      security:
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthMeResponse"
        "401":
          $ref: "#/components/responses/Error401"

  /auth/logout:
    post:
      summary: Logout
      security:
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        "401":
          $ref: "#/components/responses/Error401"

  /users:
    get:
      summary: List users
      security:
        - BearerAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsersListResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
    post:
      summary: Create user
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /users/{id}:
    patch:
      summary: Update user
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      summary: Delete user
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events/approvals:
    get:
      summary: List event approvals
      security:
        - BearerAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pending, approved, rejected]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventApprovalsResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /events/approvals/{id}/approve:
    post:
      summary: Approve event approval
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApprovalDecisionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApprovalDecisionResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events/approvals/{id}/reject:
    post:
      summary: Reject event approval
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApprovalDecisionRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApprovalDecisionResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events:
    get:
      summary: List events
      parameters:
        - in: query
          name: timeFrom
          schema:
            type: integer
        - in: query
          name: timeTo
          schema:
            type: integer
        - in: query
          name: tagIds
          schema:
            type: string
          description: Comma-separated ids
        - in: query
          name: categoryIds
          schema:
            type: string
          description: Comma-separated ids
        - in: query
          name: keyword
          schema:
            type: string
        - in: query
          name: q
          schema:
            type: string
          description: Alias of keyword
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventsListResponse"
        "400":
          $ref: "#/components/responses/Error400"
    post:
      summary: Create event
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventDraft"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "202":
          description: Accepted (approval required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PendingResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /events/search:
    get:
      summary: Search events
      parameters:
        - in: query
          name: q
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventsListResponse"
        "400":
          $ref: "#/components/responses/Error400"

  /events/aggregations:
    get:
      summary: Event aggregations
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventAggregationsResponse"

  /events/{id}:
    get:
      summary: Get event by id
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "404":
          $ref: "#/components/responses/Error404"
    patch:
      summary: Update event
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventPatch"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "202":
          description: Accepted (approval required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PendingResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      summary: Delete event
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content
        "202":
          description: Accepted (approval required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PendingResponse"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /events/{id}/versions:
    get:
      summary: Event versions
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventVersionsResponse"

  /events/{id}/restore:
    post:
      summary: Restore event version
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventRestoreRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /tags:
    get:
      summary: List tags
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TagsListResponse"
    post:
      summary: Create tag
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NamedItemDraft"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /tags/{id}:
    patch:
      summary: Update tag
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NamedItemDraft"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      summary: Delete tag
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /categories:
    get:
      summary: List categories
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoriesListResponse"
    post:
      summary: Create category
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NamedItemDraft"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Category"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /categories/{id}:
    patch:
      summary: Update category
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NamedItemDraft"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Category"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"
    delete:
      summary: Delete category
      security:
        - BearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "404":
          $ref: "#/components/responses/Error404"

  /import/events:
    post:
      summary: Import events
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ImportEventsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImportEventsResponse"
        "400":
          $ref: "#/components/responses/Error400"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"

  /export/events:
    get:
      summary: Export events
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportEventsResponse"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
  responses:
    Error400:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Error401:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Error403:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Error404:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
  schemas:
    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object

    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
        password:
          type: string

    AuthLoginResponse:
      type: object
      required: [token, expiresAt, user]
      properties:
        token:
          type: string
        expiresAt:
          type: string
        user:
          $ref: "#/components/schemas/UserPublic"

    AuthMeResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: "#/components/schemas/UserPublic"

    UserPublic:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        role:
          type: string
        profile:
          type: object

    UsersListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/UserPublic"

    UserResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: "#/components/schemas/UserPublic"

    CreateUserRequest:
      type: object
      required: [name, email, password, role]
      properties:
        name:
          type: string
        email:
          type: string
        password:
          type: string
        role:
          type: string
        profile:
          type: object

    UpdateUserRequest:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
        password:
          type: string
        role:
          type: string
        profile:
          type: object

    TimePoint:
      type: object
      required: [year]
      properties:
        year:
          type: integer
        month:
          type: integer
        day:
          type: integer

    EventTime:
      type: object
      required: [start, precision]
      properties:
        start:
          $ref: "#/components/schemas/TimePoint"
        end:
          $ref: "#/components/schemas/TimePoint"
        precision:
          type: string
        fuzzy:
          type: object

    EventDraft:
      type: object
      required: [title, time]
      properties:
        title:
          type: string
        summary:
          type: string
        time:
          $ref: "#/components/schemas/EventTime"
        tagIds:
          type: array
          items:
            type: string
        categoryIds:
          type: array
          items:
            type: string

    EventPatch:
      type: object
      properties:
        title:
          type: string
        summary:
          type: string
        time:
          $ref: "#/components/schemas/EventTime"
        tagIds:
          type: array
          items:
            type: string
        categoryIds:
          type: array
          items:
            type: string

    Event:
      allOf:
        - $ref: "#/components/schemas/EventDraft"
        - type: object
          required: [id, createdAt, updatedAt]
          properties:
            id:
              type: string
            createdAt:
              type: string
            updatedAt:
              type: string

    EventsListResponse:
      type: object
      required: [items, total]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Event"
        total:
          type: integer

    PendingResponse:
      type: object
      required: [pending, approvalId]
      properties:
        pending:
          type: boolean
        approvalId:
          type: string

    EventVersion:
      type: object
      properties:
        id:
          type: string
        eventId:
          type: string
        action:
          type: string
        changedAt:
          type: string
        changedBy:
          type: string
        note:
          type: string
        snapshot:
          $ref: "#/components/schemas/Event"

    EventVersionsResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/EventVersion"

    EventRestoreRequest:
      type: object
      required: [versionId]
      properties:
        versionId:
          type: string

    EventApproval:
      type: object
      properties:
        id:
          type: string
        action:
          type: string
        eventId:
          type: string
        draft:
          $ref: "#/components/schemas/EventDraft"
        snapshot:
          $ref: "#/components/schemas/Event"
        requestedAt:
          type: string
        requestedBy:
          type: string
        requestedByName:
          type: string
        status:
          type: string
        decidedAt:
          type: string
        decidedBy:
          type: string
        note:
          type: string
        resultEventId:
          type: string

    EventApprovalsResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/EventApproval"

    ApprovalDecisionRequest:
      type: object
      properties:
        note:
          type: string

    ApprovalDecisionResponse:
      type: object
      required: [ok, approval]
      properties:
        ok:
          type: boolean
        approval:
          $ref: "#/components/schemas/EventApproval"

    Tag:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        parentId:
          type: string

    Category:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        parentId:
          type: string

    TagsListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Tag"

    CategoriesListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Category"

    NamedItemDraft:
      type: object
      required: [name]
      properties:
        name:
          type: string
        parentId:
          type: string

    ImportEventsRequest:
      type: object
      required: [items]
      properties:
        mode:
          type: string
          enum: [merge, replace]
        items:
          type: array
          items:
            $ref: "#/components/schemas/EventDraft"

    ImportEventsResponse:
      type: object
      required: [mode, imported]
      properties:
        mode:
          type: string
        imported:
          type: integer

    ExportEventsResponse:
      type: object
      required: [exportedAt, total, items]
      properties:
        exportedAt:
          type: string
        total:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/Event"

    EventAggregationsResponse:
      type: object
      properties:
        total:
          type: integer
        years:
          type: object
          properties:
            min:
              type: integer
            max:
              type: integer
        tags:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              count:
                type: integer
        categories:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              count:
                type: integer

